<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.74.3" />
    <meta name="description" content="AWS Cloud Security Virtual Event">
<meta name="author" content="Sumit Patel">

    <link rel="shortcut icon" href="https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico" type="image/ico" />
<link rel="icon" href="https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico" type="image/ico" />

    <title>2. RDS with Secrets Manager :: AWS Cloud Security Virtual Event</title>

    
    <link href="/css/nucleus.css" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css" rel="stylesheet">
    <link href="/css/hybrid.css" rel="stylesheet">
    <link href="/css/featherlight.min.css" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/css/auto-complete.css" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <link href="/css/hugo-theme.css" rel="stylesheet">
    
    <link href="/css/theme-workshops.css" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/workshops/module4/rds/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <div>
  <a href="/" title="Go home">
      <img style="vertical-align:middle" src="/images/logo.png" height="70px" />
  </a>
</div>

    </div>
    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    
    
    <li data-nav-id="/agenda/" title="Overview" class="dd-item
    
        
        ">
      <a href="/agenda/">
          Overview
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

          
          


 
  
    
    
    
    <li data-nav-id="/workshops/" title="Workshops" class="dd-item
    parent
        
        ">
      <a href="/workshops/">
          Workshops
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
        <ul>
          
          
            
          
          

        
          
            
            


 
  
    
    
    
    <li data-nav-id="/workshops/module0/" title="Lab Setup" class="dd-item
    
        
        ">
      <a href="/workshops/module0/">
          Lab Setup
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/workshops/module1/" title="Lab 1: Eliminate Bastion Hosts with Systems Manager" class="dd-item
    
        
        ">
      <a href="/workshops/module1/">
          Lab 1: Eliminate Bastion Hosts with Systems Manager
          
            
              <i class="fas fa-caret-right"></i>
            
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
        <ul>
          
          
          

        
          
            
            


 
  
    
      <li data-nav-id="/workshops/module1/scenario/" title="1. Overview and Setup" class="dd-item ">
        <a href="/workshops/module1/scenario/">
        1. Overview and Setup
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module1/evaluate/" title="2. Evaluate Session Manager Configuration" class="dd-item ">
        <a href="/workshops/module1/evaluate/">
        2. Evaluate Session Manager Configuration
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module1/configure/" title="3. Configure Systems Manager Session Manager" class="dd-item ">
        <a href="/workshops/module1/configure/">
        3. Configure Systems Manager Session Manager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module1/portforward/" title="4. Use Port Forwarding For Web Redirection" class="dd-item ">
        <a href="/workshops/module1/portforward/">
        4. Use Port Forwarding For Web Redirection
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module1/ssh/" title="5. Enable SSH Through Session Manager" class="dd-item ">
        <a href="/workshops/module1/ssh/">
        5. Enable SSH Through Session Manager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module1/rdp/" title="6. Enable RDP Through Session Manager" class="dd-item ">
        <a href="/workshops/module1/rdp/">
        6. Enable RDP Through Session Manager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/workshops/module2/" title="Lab 2: Security through Good Governance" class="dd-item
    
        
        ">
      <a href="/workshops/module2/">
          Lab 2: Security through Good Governance
          
            
              <i class="fas fa-caret-right"></i>
            
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
        <ul>
          
          
          

        
          
            
            


 
  
    
      <li data-nav-id="/workshops/module2/sysmgrlabsetup/" title="1. AWS Systems Manager Lab Setup" class="dd-item ">
        <a href="/workshops/module2/sysmgrlabsetup/">
        1. AWS Systems Manager Lab Setup
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module2/systemsmanager/" title="2. AWS Systems Manager: Operations as Code" class="dd-item ">
        <a href="/workshops/module2/systemsmanager/">
        2. AWS Systems Manager: Operations as Code
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module2/inventory/" title="3. AWS Systems Manager: Inventory" class="dd-item ">
        <a href="/workshops/module2/inventory/">
        3. AWS Systems Manager: Inventory
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module2/statemgr/" title="4. AWS Systems Manager: State Manager" class="dd-item ">
        <a href="/workshops/module2/statemgr/">
        4. AWS Systems Manager: State Manager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module2/patch/" title="5. AWS Systems Manager: Patch Manager" class="dd-item ">
        <a href="/workshops/module2/patch/">
        5. AWS Systems Manager: Patch Manager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module2/configlabsetup/" title="6. AWS Config Lab Setup" class="dd-item ">
        <a href="/workshops/module2/configlabsetup/">
        6. AWS Config Lab Setup
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module2/config/" title="7. AWS Config: Compliance as Code" class="dd-item ">
        <a href="/workshops/module2/config/">
        7. AWS Config: Compliance as Code
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/workshops/module3/" title="Lab 3: Protecting Workloads from the Instance to the Edge" class="dd-item
    
        
        ">
      <a href="/workshops/module3/">
          Lab 3: Protecting Workloads from the Instance to the Edge
          
            
              <i class="fas fa-caret-right"></i>
            
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
        <ul>
          
          
          

        
          
            
            


 
  
    
      <li data-nav-id="/workshops/module3/scenario/" title="1. Scenario" class="dd-item ">
        <a href="/workshops/module3/scenario/">
        1. Scenario
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module3/perimeter-assess/" title="2. Perimeter Layer - Assess" class="dd-item ">
        <a href="/workshops/module3/perimeter-assess/">
        2. Perimeter Layer - Assess
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module3/perimeter-remediate/" title="3. Perimeter Layer - Remediate" class="dd-item ">
        <a href="/workshops/module3/perimeter-remediate/">
        3. Perimeter Layer - Remediate
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module3/perimeter-verify/" title="4. Perimeter Layer - Verify" class="dd-item ">
        <a href="/workshops/module3/perimeter-verify/">
        4. Perimeter Layer - Verify
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module3/host-assess/" title="5. Host Layer - Assess" class="dd-item ">
        <a href="/workshops/module3/host-assess/">
        5. Host Layer - Assess
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module3/host-remediate/" title="6. Host Layer - Remediate" class="dd-item ">
        <a href="/workshops/module3/host-remediate/">
        6. Host Layer - Remediate
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module3/host-verify/" title="7. Host Layer - Verify" class="dd-item ">
        <a href="/workshops/module3/host-verify/">
        7. Host Layer - Verify
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/workshops/module4/" title="Lab 4: AWS Secrets Manager with Amazon RDS and AWS Fargate" class="dd-item
    parent
        
        ">
      <a href="/workshops/module4/">
          Lab 4: AWS Secrets Manager with Amazon RDS and AWS Fargate
          
            
              <i class="fas fa-caret-down"></i>
            
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
        <ul>
          
          
          

        
          
            
            


 
  
    
      <li data-nav-id="/workshops/module4/scenario/" title="1. Architecture" class="dd-item ">
        <a href="/workshops/module4/scenario/">
        1. Architecture
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module4/rds/" title="2. RDS with Secrets Manager" class="dd-item active">
        <a href="/workshops/module4/rds/">
        2. RDS with Secrets Manager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/workshops/module4/fargate/" title="3. Fargate with Secrets Manager" class="dd-item ">
        <a href="/workshops/module4/fargate/">
        3. Fargate with Secrets Manager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/" title="On-Demand Tracks" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/">
          On-Demand Tracks
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
        <ul>
          
          
            
          
          

        
          
            
            


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/advanced_container_security/" title="Advanced container security" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/advanced_container_security/">
          Advanced container security
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/cloud_security_multi_account/" title="Cloud security for everyone: Multi-account strategy" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/cloud_security_multi_account/">
          Cloud security for everyone: Multi-account strategy
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/cloud-enabled_security_origin/" title="Cloud-enabled security evolution with Origin Energy" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/cloud-enabled_security_origin/">
          Cloud-enabled security evolution with Origin Energy
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/federated_access_made_simple/" title="Federated access and authorisation made simple" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/federated_access_made_simple/">
          Federated access and authorisation made simple
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/secure_real-time_tracking_afl/" title="How AFL secures real-time player tracking with encryption" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/secure_real-time_tracking_afl/">
          How AFL secures real-time player tracking with encryption
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/secops_in_your_organization/" title="How to put SecOps to work in your organisation" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/secops_in_your_organization/">
          How to put SecOps to work in your organisation
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/neoband_in_th_cloud_xinja/" title="How Xinja built a neobank on the cloud" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/neoband_in_th_cloud_xinja/">
          How Xinja built a neobank on the cloud
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/iam-best-practices/" title="IAM: Best practices for managing identity with AWS" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/iam-best-practices/">
          IAM: Best practices for managing identity with AWS
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/intro-to-aws-sec/" title="Introduction to AWS Security" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/intro-to-aws-sec/">
          Introduction to AWS Security
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/sec-best-practices-war-way/" title="Security best practices: The Well-Architected way" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/sec-best-practices-war-way/">
          Security best practices: The Well-Architected way
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
            
            


 
  
    
    
    
    <li data-nav-id="/ondemandtracks/security_fundamentals/" title="The fundamentals of AWS Security" class="dd-item
    
        
        ">
      <a href="/ondemandtracks/security_fundamentals/">
          The fundamentals of AWS Security
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          


 
  
    
    
    
    <li data-nav-id="/training/" title="Learning Resources" class="dd-item
    
        
        ">
      <a href="/training/">
          Learning Resources
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

          
          


 
  
    
    
    
    <li data-nav-id="/links/" title="Additional Links" class="dd-item
    
        
        ">
      <a href="/links/">
          Additional Links
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

          
          


 
  
    
    
    
    <li data-nav-id="/survey/" title="Survey" class="dd-item
    
        
        ">
      <a href="/survey/">
          Survey
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

          
          


 
  
    
    
    
    <li data-nav-id="/faq/" title="FAQ" class="dd-item
    
        
        ">
      <a href="/faq/">
          FAQ
          
          
            <i class="fas read-icon"></i>
          
      </a>
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      

      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>

    <h5 class="copyright">&copy; 2020 Amazon Web Services, Inc. or its Affiliates. All rights reserved.<h5>

</left>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/'>AWS Cloud Security Virtual Event</a> > <a href='/workshops/'>Workshops</a> > <a href='/workshops/module4/'>Lab 4: AWS Secrets Manager with Amazon RDS and AWS Fargate</a> > 2. RDS with Secrets Manager
          
        
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#important">Important</a></li>
    <li><a href="#view-the-cloudformation-stack">View the CloudFormation stack</a></li>
    <li><a href="#store-the-secret">Store the secret</a></li>
    <li><a href="#access-the-database">Access the database</a></li>
    <li><a href="#rotate-the-secret">Rotate the secret</a></li>
    <li><a href="#access-the-database-1">Access the database</a>
      <ul>
        <li><a href="#stuck-watch-this"><em>Stuck? Watch this</em></a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              2. RDS with Secrets Manager
            </h1>
          

        


<h2 id="overview">Overview</h2>
<p>In this phase, you will learn how to use AWS Secrets Manager for rotating the password for a private Amazon RDS database. As a reminder, the environment provisioned by CloudFormation is shown in the figure below. You will not be working with the AWS Fargate container in this phase so it is not shown below.</p>
<p><img src="/images/secrets-1.png" alt=""></p>
<h2 id="important">Important</h2>
<p>For the sake of simplicity, this tutorial uses jq to parse the secret value into environment variables to allow for easy command line manipulation. This is NOT a security best practice for a production environment. In a production environment, we recommend that you don&rsquo;t store passwords in environment variables. Click <a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/best-practices.html">here</a> to read about the best practices for using Secrets Manager.</p>
<h2 id="view-the-cloudformation-stack">View the CloudFormation stack</h2>
<ul>
<li>
<p>Go to the CloudFormation console and identify the stack that you built. Make sure you are in the correct region. The list of stacks will look similar to the figure below. The appearance may vary based on the version of the console you are using. Your stack will have a description of <strong>Workshop for AWS Secrets Manager with Amazon RDS and AWS Fargate</strong>.
<img src="/images/sec-2.png" alt=""></p>
</li>
<li>
<p>Click the stack name link to reveal more information about the stack as shown in the figure below.
<img src="/images/sec-3.png" alt=""></p>
</li>
<li>
<p>Click the Outputs tab as shown in the figure above to list the outputs of the stack which will be similar to the figure below.
<img src="/images/sec-4.png" alt=""></p>
</li>
</ul>
<p>The meanings of the output values are described in the table below.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Meaning of Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>BastionIP</td>
<td>The IP address of the bastion host</td>
</tr>
<tr>
<td>DBInstance</td>
<td>The Amazon RDS instance id</td>
</tr>
<tr>
<td>DBPassword</td>
<td>The master password of the RDS data base</td>
</tr>
<tr>
<td>DBUser</td>
<td>The master user of the RDS data base</td>
</tr>
<tr>
<td>EC2UserPassword</td>
<td>The password for the ec2-user id</td>
</tr>
<tr>
<td>ECRRepository</td>
<td>The ECR repository id</td>
</tr>
<tr>
<td>ECSCluster</td>
<td>The ECS cluster id</td>
</tr>
</tbody>
</table>
<p>You will need the values in the DBInstance, DBPassword, DBUser, and EC2UserPassword outputs in the next section so copy them to a file on your desktop so they are readily available.</p>
<h2 id="store-the-secret">Store the secret</h2>
<p>In this section, you will store the RDS database credentials in AWS Secrets Manager.</p>
<ul>
<li>Go to the <a href="https://console.aws.amazon.com/secretsmanager">Secrets Manager console</a>.</li>
<li>Check your region to make sure the Secrets Manager console is operating in the ap-southeast-2 region.</li>
<li>Click <strong>Store a new secret</strong>.</li>
<li>Select the <strong>Credentials for RDS database</strong> radio button.</li>
<li>Copy the values for the DBUser and DBPassword CloudFormation output values that you got from the CloudFormation stack into the <strong>User name</strong> and <strong>Password</strong> fields respectively.</li>
<li>For the encryption key, Secrets Manager gives you the option of using the default KMS key that Secrets Manager creates for your account. This default key is managed by Secrets Manager itself. It provides encryption but you do not have the ability manage the policies or grants for the key. You can also specify your own KMS key which gives you more the option of configuring grants and policies that provide more granular permissions. In a production environment that requires fine-grained security controls, you would likely choose your own key. For this workshop we do not require these additional controls so select <strong>DefaultEncryptionKey</strong> in the dropdown menu.</li>
<li>Scroll down to the bottom of the page and you will see a list of your RDS instances. Select the RDS instance based on the DBInstance CloudFormation output value.
<img src="/images/sec-5.png" alt=""></li>
<li>Click <strong>Next</strong>.</li>
<li>Enter a name for the secret. Use <strong>smdemo</strong> as shown below.
<img src="/images/sec-6.png" alt=""></li>
<li>Click <strong>Next</strong>.</li>
<li>Select <strong>Disable automatic rotation</strong> and then click <strong>Next</strong>. We will enable rotation later in this module.
<img src="/images/sec-7.png" alt=""></li>
<li>Click <strong>Store</strong>.</li>
</ul>
<p>You have now stored your secret value as shown below.
<img src="/images/sec-10.png" alt=""></p>
<h2 id="access-the-database">Access the database</h2>
<p>In this section, you will connect to the bastion host so you can run scripts that the CloudFormation template has created on the instance.</p>
<ul>
<li>
<p>Connect to the bastion host using AWS Systems Manager Session Manager. To do this:</p>
<ul>
<li>Go to the <a href="https://console.aws.amazon.com/systems-manager">Systems Manager console</a>.</li>
<li>Click <strong>Session Manager</strong>.</li>
<li>Click <strong>Start session</strong>.</li>
<li>Select the radio button for the instance called <strong>smdemo-host</strong>.</li>
<li>Click <strong>Start session</strong>.</li>
</ul>
</li>
<li>
<p>The scripts you will be using are owned by the ec2-user account. Enter the command below to change your effective user id and directory to those of ec2-user:</p>
</li>
</ul>
<pre><code>sudo su - ec2-user
</code></pre><ul>
<li>Display the current directory using this command:</li>
</ul>
<pre><code>ls
</code></pre><p>You will see two shell scripts.</p>
<ul>
<li>mysql.oldway.sh - This shell script connects to the database the &ldquo;old&rdquo; way, using a hard-coded password.</li>
<li>mysql.newway.sh - This shell script connects to the database the &ldquo;new&rdquo; way, using AWS Secrets Manager.</li>
<li>View the file mysql.oldway.sh using this command:</li>
</ul>
<pre><code>cat mysql.oldway.sh
</code></pre><p>You will see contents similar to the lines below. The values PASSWORD, USER, and ENDPOINT represent the hard-coded database password, username, and host endpoint.</p>
<pre><code>(Note: This code fragment is for illustration only and not intended for copying.)

#/bin/bash

# mysql.oldway.sh

# This is the old way of accessing a database, with a hard-coded password.
# This script will only work right after the CloudFormation template runs.
# After you store and rotate the secret, you will need to use the
# mysql.newway.sh script.

mysql \
-pPASSWORD \
-u USER \
-P 3306 \
-h ENDPOINT
</code></pre><ul>
<li>Test the script mysql.oldway.sh using the commands shown below. The first command invokes the script. The subsequent commands select the database, display the table names in the database, query the rows in the table, and exit MySQL. Note that MySQL commands end with a semicolon (&quot;;&quot;).</li>
</ul>
<pre><code>./mysql.oldway.sh
use smdemo;
show tables;
select * from bookinfo;
quit;
</code></pre><p>You can see an example of the output below. This shows that you can access the database, the &ldquo;old&rdquo; way, with a hard-coded user name and password. You may be wondering why MariaDB appears in the image below. Amazon Linux 2 includes the MariaDB port of the mysql command as an &ldquo;extras&rdquo; module. The mysql program is compatible with both MySQL and MariaDB.
<img src="/images/sec-11.png" alt=""></p>
<ul>
<li>View the file mysql.newway.sh by entering this command:</li>
</ul>
<pre><code>cat mysql.newway.sh
</code></pre><p>Take a look at the lines below.</p>
<pre><code>(Note: This code fragment is for illustration and not intended for copying.)

getsecretvalue() {
  aws secretsmanager get-secret-value --secret-id $1 | \
    jq .SecretString | \
    jq fromjson
}
</code></pre><p>The above lines define a shell function that uses the AWS CLI to retrieve the secret whose name is passed as a command line argument ($1). The result is a JSON string so the jq utility is used to extract the actual value of the secret whose JSON key is named SecretString. Here is an example of what a SecretString looks like:</p>
<pre><code>(Note: This code fragment is for illustration and not intended for copying.)

{
  &quot;engine&quot;: &quot;mysql&quot;,
  &quot;username&quot;: &quot;myuser&quot;,
  &quot;password&quot;: &quot;mypassword&quot;,
  &quot;host&quot;: &quot;my-database-endpoint.ap-southeast-2.rds.amazonaws.com&quot;,
  &quot;dbname&quot;: &quot;myDatabase&quot;,
  &quot;port&quot;: &quot;3306&quot;
}
</code></pre><p>Note that the SecretString itself is a JSON structure. Now look at the following lines.</p>
<pre><code>(Note: This code fragment is for illustration and not intended for copying.)

secret=`getsecretvalue $1`
user=$(echo $secret | jq -r .username)
password=$(echo $secret | jq -r .password)
endpoint=$(echo $secret | jq -r .host)
port=$(echo $secret | jq -r .port)
</code></pre><p>These lines call the shell function and then use jq to extract the database username, password, endpoint, and port from the SecretString. These are then passed to the mysql command as shown on the lines below. Note that there is no space after the -p option.</p>
<pre><code>(Note: This code fragment is for illustration and not intended for copying.)

mysql \
-p$password \
-u $user \
-P $port \
-h $endpoint
</code></pre><ul>
<li>Run the mysql.newway.sh script by running the commands below. The first command invokes the script. <strong>Note that you must specify the name of the secret!</strong> In this example, the secret&rsquo;s name is smdemo. The subsequent commands select the database, display the table names in the database, query the rows in the table, and exit MySQL.</li>
</ul>
<pre><code>./mysql.newway.sh smdemo
use smdemo;
show tables;
select * from bookinfo;
quit;
</code></pre><p>You can see an example of the output below. This shows that you can access the database, the &ldquo;new&rdquo; way, using AWS Secrets Manager.
<img src="/images/sec-12.png" alt=""></p>
<h2 id="rotate-the-secret">Rotate the secret</h2>
<p>In this section, you will enable the rotation of the secret you created in AWS Secrets Manager.</p>
<ul>
<li>Go to the <a href="https://console.aws.amazon.com/secretsmanager">Secrets Manager console</a>.</li>
<li>Check your region to make sure the Secrets Manager console is operating in the ap-southeast2 region.</li>
<li>Click on the secret that you previously created.</li>
<li>Click <strong>Edit rotation</strong>.</li>
<li>Select <strong>Enable automatic rotation</strong>.</li>
<li>Choose <strong>30 days</strong> for the rotation interval.</li>
<li>Select the <strong>Create a new Lambda function to perform rotation</strong> radio button. This will cause Secrets Manager to use CloudFormation on your behalf to create a rotation function using the AWS Serverless Application Repository. If you had customized your own rotation function or if you were using a credential for a special application, you would select that here.</li>
<li>Enter a name for the rotation function. In the figure below, we used <strong>smdemo</strong> but you can select whatever you wish.</li>
<li>You now need to select the secret whose permissions will be used to rotate the secret. For this Builder Session, select <strong>Use this secret</strong>. This will tell the rotation function to access the RDS database using the secret and rotate the same secret.</li>
</ul>
<p>If your application supports two classes of users, for example a &ldquo;superuser&rdquo; and a &ldquo;normal privilege&rdquo; user, you could select <strong>Use a secret that I have previously stored in Secrets Manager</strong> and use the &ldquo;superuser&rdquo; credential to rotate the credential for the &ldquo;normal privilege&rdquo; user.</p>
<p>Your window should look similar to the figure below.
<img src="/images/sec-13.png" alt=""></p>
<ul>
<li>Click <strong>Save</strong>.</li>
<li>You will see a message telling you that the rotation is beginning and that you should remain on the page until it is complete. AWS Secrets Manager is now using the <a href="https://aws.amazon.com/serverless/serverlessrepo/">AWS Serverless Application Repository</a> to install an <a href="https://aws.amazon.com/lambda/">AWS Lambda rotation</a> function on your behalf. <strong>Do not leave this page until the rotation is complete</strong>.
<img src="/images/sec-14.png" alt=""></li>
</ul>

<div class="notices note" ><p>If you see the following error message, goto the <a href="https://ap-southeast-2.console.aws.amazon.com/lambda/home?region=ap-southeast-2#/functions">AWS Lambda</a> and verify the Lambda function <strong>secretsManagersmdemo</strong> exists, than follow the above <a href="https://awscloudsecvirtualevent.com/workshops/module4/rds/#rotate-the-secret">Rotate steps</a> again but this time selecting <strong>Use an existing lambda function to perform rotation</strong> and choose <strong>secretsManagersmdemo</strong> Lambda function to enable automatic rotation. <img src="/images/error-rotate.png" alt=""></p>
</div>

<p>A message will appear when the rotation is complete. <strong>Refresh your browser window to update your any cached fields</strong>.
<img src="/images/sec-15.png" alt=""></p>
<ul>
<li>Click <strong>Retrieve secret value</strong> to see the new password value.</li>
</ul>
<h2 id="access-the-database-1">Access the database</h2>
<p>Let&rsquo;s try to connect to the database again, both the &ldquo;old&rdquo; way with a hard-coded password, the &ldquo;new&rdquo; way with AWS Secrets Manager.</p>
<ul>
<li>On the bastion host, run the command below to access the database using the hard-coded password.</li>
</ul>
<pre><code>./mysql.oldway.sh
</code></pre><p>You should receive an error message (access denied) because the mysql.oldway.sh script has the same hard-coded password.
<img src="/images/sec-16.png" alt=""></p>
<ul>
<li>Run the commands below to access the database with Secrets Manager by running the commands below. <strong>Note that you must specify the name of the secret!</strong> In this example, the secret&rsquo;s name is smdemo. You should be able to access the database as you did before because Secrets Manager fetches the new credential rather than using a hard-coded credential.</li>
</ul>
<pre><code>./mysql.newway.sh smdemo
use smdemo;
show tables;
select * from bookinfo;
quit;
</code></pre><p>You have completed ths RDS phase and have learned how to use AWS Secrets Manager with Amazon RDS. You will now continue to the Fargate phase.</p>
<hr>
<h3 id="stuck-watch-this"><em>Stuck? Watch this</em></h3>

<div class="notices note" ><p><em>This video has no audio</em></p>
</div>



<video width="696" height="392" controls>
  <source src="https://d1tqhetmq9f85b.cloudfront.net/downloads/lab4.2.mp4" type="video/mp4">
  Your browser doesn't support video.
</video>




<footer class="footline">
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/workshops/module4/scenario/" title="1. Architecture"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/workshops/module4/fargate/" title="3. Fargate with Secrets Manager" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/perfect-scrollbar.min.js"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/js/jquery.sticky.js"></script>
    <script src="/js/featherlight.min.js"></script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js"></script>
    <script src="/js/learn.js"></script>
    <script src="/js/hugo-learn.js"></script>

    <link href="/mermaid/mermaid.css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

